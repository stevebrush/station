!function(e,t){"use strict";var n=e.module("Station");n.controller("MapCtrl",["$scope","regionService",function(e,t){t.findAll().then(function(t){e.regions=t}),e.preview=function(t){e.showcase=t}}]),n.controller("RegionCtrl",["$scope","$routeParams","regionService",function(e,t,n){n.find(t.id).then(function(t){e.region=t})}]),n.controller("LocationCtrl",["$scope","$routeParams","locationService","playerService",function(e,n,a,o){e.showRoom=!0,e.showVessel=!1,e.showShop=!1,e.openVessel=function(n){t.log("Open vessel:",n),e.roomPlacementId=n,e.showRoom=!1,e.showVessel=!0},e.closeVessel=function(){e.showRoom=!0,e.showVessel=!1,e.roomPlacementId=null},e.openShop=function(n){t.log("Open shop:",n),e.roomPlacementId=n,e.showRoom=!1,e.showShop=!0},e.closeShop=function(){e.showRoom=!0,e.showShop=!1,e.roomPlacementId=null},e.openEnemy=function(e){t.log("Open enemy",e)},o.getPlayer().then(function(t){e.player=t}),a.find(n.id).then(function(n){e.location=n,e.room=n.rooms[0],t.log("Rooms:",e.room)})}]),n.controller("ShopCtrl",["$routeParams","playerService","npcService","$sce","$rootScope",function(n,a,o,i,r){function l(){m&&v&&(p(),d.isReady=!0)}function s(t,n){var a=n.items,o=e.copy(t),i=function(e){for(var t in a)if(a[t].itemId===e.itemId){delete a[t];break}};return 1===t.quantity?i(t):(t.quantity-=t.quantityRequested,o.quantity=t.quantityRequested,t.quantity<1&&i(t)),o}function c(e,n){var a=!1,o=n.items;e.inCart=!e.inCart;for(var i in o)if("undefined"==typeof o[i].inCart&&(t.log("Set inCart to false!!!",o[i].name),o[i].inCart=!1),o[i].itemId===e.itemId&&o[i].inCart===e.inCart){o[i].quantity+=e.quantity,a=!0;break}a||(o.push(e),y(n)),u()}function u(){var e=0,t=0,n,a;a=d.trader.items;for(n in a)a[n].inCart===!0&&(e+=a[n].value*a[n].quantity);a=d.player.items;for(n in a)a[n].inCart===!0&&(t+=a[n].value*a[n].quantity);d.totals.difference=e-t,d.totals.display=f(d.totals.difference),d.isDisabled=d.totals.difference<0&&d.isOverage}function f(e){return 0===e?(d.isOverage=!1,d.totals.label="--","0"):0>e&&-1*d.player.money>e?(d.isOverage=!0,d.totals.label="Loss",e):d.trader.money<e?(d.isOverage=!0,e=d.trader.money,d.totals.label="Profit","+"+d.trader.money):(d.isOverage=!1,d.totals.label="Profit","+"+e)}function p(){var e=.5,t=.6,n;for(var a in d.player.items)n=d.player.items[a],n.value=Math.round(n.baseValue-n.baseValue*e);for(var o in d.trader.items)n=d.trader.items[o],n.value=Math.round(n.baseValue*(1+t))}function y(e){var t=[];for(var n in e.items)e.items[n].inCart===!0?t.unshift(e.items[n]):t.push(e.items[n]);e.items=t}var d=this,m=!1,v=!1,h={player:null,trader:null};d.player={},d.trader={},d.npcId=n.id,d.isReady=!1,d.totals={difference:0,display:"0",label:"--"},d.isDisabled=!0,a.getPlayer().then(function(n){t.log("playerService: ",n),h.player=e.copy(n.items),d.player=n,m=!0,l()}),o.find(d.npcRoomPlacementId).then(function(n){t.log("npcService: ",n),h.trader=e.copy(n.items),d.trader=n,v=!0,l()}),d.buy={label:i.trustAsHtml("Take"),onPreview:function(e){this.label=e.inCart===!0?i.trustAsHtml('<span class="fa fa-arrow-up"></span>Take Back'):i.trustAsHtml('<span class="fa fa-arrow-up"></span>Take')},onAccept:function(n){t.log("Buying...",e.copy(n));var a=s(n,d.trader);t.log("Buying clone: ",e.copy(a)),c(a,d.player),t.log("Player items after: ",d.player.items)},onCancel:function(){}},d.sell={label:i.trustAsHtml("Offer"),onPreview:function(e){this.label=e.inCart===!0?i.trustAsHtml('<span class="fa fa-arrow-down"></span>Give Back'):i.trustAsHtml('<span class="fa fa-arrow-down"></span>Offer')},onAccept:function(n){t.log("Selling...",e.copy(n));var a=s(n,d.player);t.log("Selling clone: ",e.copy(a)),c(a,d.trader)},onCancel:function(){}},d.back=function(){d.player.items=h.player,d.trader.items=h.trader,r.back()}}]),n.controller("InventoryCtrl",function(){function e(e){t.bundleValue=t.quantityRequested*e.value}var t=this;t.bundleValue=0,t.increaseQuantity=function(n){t.quantityRequested++,t.quantityRequested>n.quantity&&(t.quantityRequested=n.quantity),e(n)},t.decreaseQuantity=function(n){t.quantityRequested--,t.quantityRequested<1&&(t.quantityRequested=1),e(n)},t.preview=function(e){t.action&&t.action.onPreview&&t.action.onPreview.call(t.action,e),t.showcase=e},t.requestQuantity=function(n){1===n.quantity?(t.quantityRequested=1,t.accept(n)):(t.showQuantitySelect=!0,t.quantityRequested=n.quantity,e(n))},t.accept=function(e){e.quantityRequested=t.quantityRequested||1,t.action.onAccept(e),t.cancel()},t.cancel=function(){delete t.quantityRequested,delete t.showcase,t.showQuantitySelect=!1}}),n.controller("VesselCtrl",["playerService","vesselService","$sce",function(e,t,n){var a=this;e.getPlayer().then(function(e){a.player=e}),t.find(a.vesselRoomPlacementId).then(function(e){a.vessel=e}),a.take={label:n.trustAsHtml('<span class="fa fa-arrow-up"></span>Take'),onPreview:function(){},onAccept:function(){},onCancel:function(){}},a.store={label:n.trustAsHtml('<span class="fa fa-arrow-down"></span>Store'),onPreview:function(){},onAccept:function(){},onCancel:function(){}}}]),n.controller("PickpocketCtrl",["$scope","$routeParams","playerService","npcService","$sce","$rootScope",function(t,n,a,o,i,r){function l(){t.isReady=s&&c}var s=!1,c=!1,u={player:null,npc:null};t.npcId=n.id,t.isReady=!1,a.getPlayer().then(function(n){t.player=n,a.getInventory().then(function(n){u.player=e.copy(n.items),t.player.items=n.items,s=!0,l()})}),o.find(t.npcId).then(function(n){t.npc=n,o.getInventory(t.npcId).then(function(n){u.npc=e.copy(n.items),t.npc.items=n.items,c=!0,l()})}),t.back=function(){t.player.items=u.player,t.npc.items=u.npc,r.back()}}])}(window.angular,window.console);