!function(e,n){"use strict";n.log("Hello, World!");var t=e.module("Station",["ngTouch","ngRoute"]);t.run(["$rootScope","$location",function(e,n){var t=[];e.$on("$routeChangeSuccess",function(){t.push(n.$$path)}),e.back=function(){var e=t.length>1?t.splice(-2)[0]:"/";n.path(e)}}]),t.config(["$routeProvider",function(e){e.when("/map",{templateUrl:"app/views/map.html",controller:"MapCtrl"}).when("/region/:id",{templateUrl:"app/views/region.html",controller:"RegionCtrl"}).when("/location/:id",{templateUrl:"app/views/location.html",controller:"LocationCtrl"}).when("/pack",{templateUrl:"app/views/pack.html",controller:["$scope","playerService",function(e,n){n.getInventory().then(function(n){e.player=n})}]}).when("/pickpocket/:id",{templateUrl:"app/views/pickpocket.html",controller:"PickpocketCtrl"}).otherwise({redirectTo:"/map"})}])}(window.angular,window.console),function(e,n){"use strict";n.log("Loading services...Done.");var t=e.module("Station");t.factory("Lawnchair",function(){return window.Lawnchair}),t.factory("Resource",["$http","$q","Lawnchair",function(e,t,o){function r(o){function r(e){var r=t.defer();return a.get(o.key,function(t){t=t||{},t.records=t.records||{},"undefined"!=typeof t.records[e]?(n.log("Storage found! Let's use that..."),r.resolve(t.records[e])):i(e).then(function(n){t.records[e]=n[o.key],a.save({key:o.key,records:t.records}),s=t.records,r.resolve(t.records[e])})}),r.promise}function i(n){var r=t.defer();return e.get(o.endpoint.one+n).success(function(e){r.resolve(e)}).error(function(e){r.resolve(e)}),r.promise}function c(){var n=t.defer();return e.get(o.endpoint.all).success(function(e){n.resolve(e)}).error(function(e){n.resolve(e)}),n.promise}function l(){var e=t.defer();return a.get(o.key,function(t){t=t||{},t.allCached===!0&&t.records?(n.log("All items have been searched already!"),e.resolve(t.records)):c().then(function(n){a.save({key:o.key,records:n[o.key],allCached:!0}),s=n[o.key],e.resolve(s)})}),e.promise}var s={};return{find:r,findAll:l,cache:function(){return s}}}var a=new o({name:"Station"});return a.nuke(),{getInstance:function(e){return new r(e)},storage:function(){return a}}}]),t.factory("inventoryService",["Resource",function(e){var n=new e.getInstance({key:"Items",endpoint:{all:"api/items"}}),t={};return t.search=function(e){var t=n.cache();for(var o in t)if(t[o].itemId===e)return t[o];return!1},t.sortAlpha=function(e){return e.sort(function(e,n){var t=e.name.toUpperCase(),o=n.name.toUpperCase();return o>t?-1:t>o?1:0}),e},t.merge=function(e){var n,o,r=[];for(var a in e)if(o=e[a],n=t.search(o.itemId)){r[a]=o;for(var i in n)r[a][i]=n[i]}return r},t.findAll=n.findAll,t}]),t.factory("playerService",["inventoryService","Resource","$q",function(e,n,t){var o=n.getInstance({key:"Player",endpoint:{all:"models/player.json"}}),r={};return r.getPlayer=function(){var n=t.defer();return e.findAll().then(function(){o.findAll().then(function(t){t.items=e.merge(t.items),n.resolve(t)})}),n.promise},r}]),t.factory("npcService",["inventoryService","Resource",function(e,n){var t=n.getInstance({key:"NPC",endpoint:{one:"api/npc/"}}),o={};return o.find=t.find,o}]),t.factory("vesselService",["Resource",function(e){return e.getInstance({key:"Vessel",endpoint:{one:"api/vessel/"}})}]),t.factory("regionService",["Resource",function(e){return e.getInstance({key:"Region",endpoint:{all:"api/regions",one:"api/region/"}})}]),t.factory("locationService",["Resource",function(e){return e.getInstance({key:"Location",endpoint:{one:"api/location/"}})}])}(window.angular,window.console),function(e,n){"use strict";n.log("Loading directives...Done.");var t=e.module("Station");t.directive("stInventory",function(){return{templateUrl:"app/partials/inventory.html",restrict:"E",replace:!0,scope:!0,bindToController:{owner:"=",action:"=",showMoney:"=",isOverage:"="},controller:"InventoryCtrl as inventory"}}),t.directive("stVessel",function(){return{templateUrl:"app/partials/vessel.html",restrict:"E",replace:!0,scope:!0,bindToController:{roomPlacementId:"=",action:"="},controller:"VesselCtrl as vessel"}}),t.directive("stShop",function(){return{templateUrl:"app/partials/shop.html",restrict:"E",replace:!0,scope:!0,bindToController:{roomPlacementId:"=",action:"="},controller:"ShopCtrl as shop"}})}(window.angular,window.console),function(e,n){"use strict";n.log("Loading controllers...Done.");var t=e.module("Station");t.controller("MapCtrl",["$scope","regionService",function(e,n){n.findAll().then(function(n){e.regions=n}),e.preview=function(n){e.showcase=n}}]),t.controller("RegionCtrl",["$scope","$routeParams","regionService",function(e,n,t){t.find(n.id).then(function(n){e.region=n})}]),t.controller("LocationCtrl",["$scope","$routeParams","locationService","playerService",function(e,t,o,r){e.showRoom=!0,e.showVessel=!1,e.showShop=!1,e.openVessel=function(t){n.log("Open vessel:",t),e.roomPlacementId=t,e.showRoom=!1,e.showVessel=!0},e.closeVessel=function(){e.showRoom=!0,e.showVessel=!1,e.roomPlacementId=null},e.openShop=function(n){e.roomPlacementId=n,e.showRoom=!1,e.showShop=!0},e.closeShop=function(){e.showRoom=!0,e.showShop=!1,e.roomPlacementId=null},e.openEnemy=function(e){n.log("Open enemy",e)},e.nextRoom=function(t){n.log("Next room id:",t);for(var o in e.location.rooms)n.log(e.location.rooms[o].roomId,t),e.location.rooms[o].roomId===t&&(e.room=e.location.rooms[o])},r.getPlayer().then(function(n){e.player=n}),o.find(t.id).then(function(t){n.log("This location: ",t),e.location=t,e.room=t.rooms[0],n.log("This room: ",e.room)})}]),t.controller("ShopCtrl",["$routeParams","playerService","npcService","inventoryService","$sce","$rootScope",function(t,o,r,a,i,c){function l(){h&&w&&(m(),y.isReady=!0)}function s(e,n){for(var t in n)if(n[t].itemId===e.itemId&&n[t].inCart===e.inCart){delete n[t];break}}function u(n,t,o){var r=e.copy(n);return 1===r.quantity?s(n,o.items):(n.quantity-=t,r.quantity=t,n.quantity<1&&s(n,o.items)),r}function p(e,n){var t=!1,o=n.items;"boolean"==typeof e.inCart?e.inCart=!e.inCart:e.inCart=!0;for(var r in o)if("undefined"==typeof o[r].inCart&&(o[r].inCart=!1),o[r].itemId===e.itemId&&o[r].inCart===e.inCart){o[r].quantity+=e.quantity,t=!0;break}t||(o.push(e),v(n)),f()}function f(){var e=0,n=0,t,o;o=y.trader.items;for(t in o)o[t].inCart===!0&&(e+=o[t].value*o[t].quantity);o=y.player.items;for(t in o)o[t].inCart===!0&&(n+=o[t].value*o[t].quantity);y.totals.difference=e-n,y.totals.display=d(y.totals.difference),y.isDisabled=y.totals.difference<0&&y.isOverage}function d(e){return 0===e?(y.isOverage=!1,y.totals.label="--","0"):0>e&&-1*y.player.money>e?(y.isOverage=!0,y.totals.label="Loss",e):y.trader.money<e?(y.isOverage=!0,e=y.trader.money,y.totals.label="Profit","+"+y.trader.money):(y.isOverage=!1,y.totals.label="Profit","+"+e)}function m(){var e=.5,n=.6,t;for(var o in y.player.items)t=y.player.items[o],t.value=Math.round(t.baseValue-t.baseValue*e);for(var r in y.trader.items)t=y.trader.items[r],t.value=Math.round(t.baseValue*(1+n))}function v(e){var n=[],t=[];for(var o in e.items)e.items[o].inCart===!0?n.push(e.items[o]):t.push(e.items[o]);n=a.sortAlpha(n),t=a.sortAlpha(t),e.items=n.concat(t)}var y=this,h=!1,w=!1,g={player:null,trader:null};y.player={},y.trader={},y.npcId=t.id,y.isReady=!1,y.totals={difference:0,display:"0",label:"--"},y.isDisabled=!0,o.getPlayer().then(function(t){n.log("playerService: ",t),g.player=e.copy(t.items),y.player=t,h=!0,l()}),r.find(y.roomPlacementId).then(function(t){n.log("npcService: ",t),g.trader=e.copy(t.items),y.trader=t,w=!0,l()}),y.buy={label:i.trustAsHtml("Take"),onPreview:function(e){this.label=e.inCart===!0?i.trustAsHtml('<span class="fa fa-arrow-up"></span>Take Back'):i.trustAsHtml('<span class="fa fa-arrow-up"></span>Take')},onAccept:function(e,n){var t=u(e,n,y.trader);p(t,y.player)},onCancel:function(){}},y.sell={label:i.trustAsHtml("Offer"),onPreview:function(e){this.label=e.inCart===!0?i.trustAsHtml('<span class="fa fa-arrow-down"></span>Give Back'):i.trustAsHtml('<span class="fa fa-arrow-down"></span>Offer')},onAccept:function(e,n){var t=u(e,n,y.player);p(t,y.trader)},onCancel:function(){}},y.back=function(){y.player.items=g.player,y.trader.items=g.trader,c.back()}}]),t.controller("InventoryCtrl",function(){function e(e){n.bundleValue=n.quantityRequested*e.value}var n=this;n.bundleValue=0,n.increaseQuantity=function(t){n.quantityRequested++,n.quantityRequested>t.quantity&&(n.quantityRequested=t.quantity),e(t)},n.decreaseQuantity=function(t){n.quantityRequested--,n.quantityRequested<1&&(n.quantityRequested=1),e(t)},n.preview=function(e){n.action&&n.action.onPreview&&n.action.onPreview.call(n.action,e),n.showcase=e},n.requestQuantity=function(t){1===t.quantity?(n.quantityRequested=1,n.accept(t)):(n.showQuantitySelect=!0,n.quantityRequested=t.quantity,e(t))},n.accept=function(e){n.action.onAccept(e,n.quantityRequested),n.cancel()},n.cancel=function(){delete n.quantityRequested,delete n.showcase,n.showQuantitySelect=!1}}),t.controller("VesselCtrl",["playerService","vesselService","$sce",function(e,t,o){var r=this;e.getPlayer().then(function(e){r.player=e}),t.find(r.roomPlacementId).then(function(e){n.log("Vessel: ",e),r.vessel=e}),r.take={label:o.trustAsHtml('<span class="fa fa-arrow-up"></span>Take'),onPreview:function(){},onAccept:function(){},onCancel:function(){}},r.store={label:o.trustAsHtml('<span class="fa fa-arrow-down"></span>Store'),onPreview:function(){},onAccept:function(){},onCancel:function(){}}}]),t.controller("PickpocketCtrl",["$scope","$routeParams","playerService","npcService","$sce","$rootScope",function(n,t,o,r,a,i){function c(){n.isReady=l&&s}var l=!1,s=!1,u={player:null,npc:null};n.npcId=t.id,n.isReady=!1,o.getPlayer().then(function(t){n.player=t,o.getInventory().then(function(t){u.player=e.copy(t.items),n.player.items=t.items,l=!0,c()})}),r.find(n.npcId).then(function(t){n.npc=t,r.getInventory(n.npcId).then(function(t){u.npc=e.copy(t.items),n.npc.items=t.items,s=!0,c()})}),n.back=function(){n.player.items=u.player,n.npc.items=u.npc,i.back()}}])}(window.angular,window.console);