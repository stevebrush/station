!function(e,n){"use strict";n.log("Hello, World!");var t=e.module("Station",["ngTouch","ngRoute"]);t.run(["$rootScope","$location",function(e,n){var t=[];e.$on("$routeChangeSuccess",function(){t.push(n.$$path)}),e.back=function(){var e=t.length>1?t.splice(-2)[0]:"/";n.path(e)}}]),t.config(["$routeProvider",function(e){e.when("/map",{templateUrl:"app/views/map.html",controller:"MapCtrl"}).when("/region/:id",{templateUrl:"app/views/region.html",controller:"RegionCtrl"}).when("/location/:id",{templateUrl:"app/views/location.html",controller:"LocationCtrl"}).when("/pack",{templateUrl:"app/views/pack.html",controller:["$scope","playerService",function(e,n){n.getInventory().then(function(n){e.player=n})}]}).when("/pickpocket/:id",{templateUrl:"app/views/pickpocket.html",controller:"PickpocketCtrl"}).otherwise({redirectTo:"/map"})}])}(window.angular,window.console),function(e,n){"use strict";n.log("Loading services...Done.");var t=e.module("Station");t.factory("Lawnchair",function(){return window.Lawnchair}),t.factory("Resource",["$http","$q","Lawnchair",function(e,t,r){function o(r){function o(e){var o=t.defer();return a.get(r.key,function(t){t=t||{},t.records=t.records||{},"undefined"!=typeof t.records[e]?(n.log("Storage found! Let's use that..."),o.resolve(t.records[e])):i(e).then(function(n){t.records[e]=n[r.key],a.save({key:r.key,records:t.records}),s=t.records,o.resolve(t.records[e])})}),o.promise}function i(n){var o=t.defer();return e.get(r.endpoint.one+n).success(function(e){o.resolve(e)}).error(function(e){o.resolve(e)}),o.promise}function c(){var n=t.defer();return e.get(r.endpoint.all).success(function(e){n.resolve(e)}).error(function(e){n.resolve(e)}),n.promise}function l(){var e=t.defer();return a.get(r.key,function(t){t=t||{},t.allCached===!0&&t.records?(n.log("All items have been searched already!"),e.resolve(t.records)):c().then(function(n){a.save({key:r.key,records:n[r.key],allCached:!0}),s=n[r.key],e.resolve(s)})}),e.promise}var s={};return{find:o,findAll:l,cache:function(){return s}}}var a=new r({name:"Station"});return a.nuke(),{getInstance:function(e){return new o(e)},storage:function(){return a}}}]),t.factory("inventoryService",["Resource",function(e){var n=new e.getInstance({key:"Items",endpoint:{all:"api/items"}}),t={};return t.search=function(e){var t=n.cache();for(var r in t)if(t[r].itemId===e)return t[r];return!1},t.sortAlpha=function(e){return e.sort(function(e,n){var t=e.name.toUpperCase(),r=n.name.toUpperCase();return r>t?-1:t>r?1:0}),e},t.merge=function(e){var n,r,o=[];for(var a in e)if(r=e[a],n=t.search(r.itemId)){o[a]=r;for(var i in n)o[a][i]=n[i]}return o},t.findAll=n.findAll,t}]),t.factory("playerService",["inventoryService","Resource","$q",function(e,n,t){var r=n.getInstance({key:"Player",endpoint:{all:"models/player.json"}}),o={};return o.getPlayer=function(){var n=t.defer();return e.findAll().then(function(){r.findAll().then(function(t){t.items=e.merge(t.items),n.resolve(t)})}),n.promise},o}]),t.factory("npcService",["inventoryService","Resource",function(e,n){var t=n.getInstance({key:"NPC",endpoint:{one:"api/npc/"}}),r={};return r.find=t.find,r}]),t.factory("vesselService",["Resource",function(e){return e.getInstance({key:"Vessel",endpoint:{one:"api/vessel/"}})}]),t.factory("regionService",["Resource",function(e){return e.getInstance({key:"Region",endpoint:{all:"api/regions",one:"api/region/"}})}]),t.factory("locationService",["Resource",function(e){return e.getInstance({key:"Location",endpoint:{one:"api/location/"}})}])}(window.angular,window.console),function(e,n){"use strict";n.log("Loading directives...Done.");var t=e.module("Station");t.directive("stInventory",function(){return{templateUrl:"app/partials/inventory.html",restrict:"E",replace:!0,scope:!0,bindToController:{owner:"=",action:"=",showMoney:"=",isOverage:"="},controller:"InventoryCtrl as inventory"}}),t.directive("stVessel",function(){return{templateUrl:"app/partials/vessel.html",restrict:"E",replace:!0,scope:!0,bindToController:{roomPlacementId:"=",action:"="},controller:"VesselCtrl as vessel"}}),t.directive("stShop",function(){return{templateUrl:"app/partials/shop.html",restrict:"E",replace:!0,scope:!0,bindToController:{roomPlacementId:"=",action:"="},controller:"ShopCtrl as shop"}})}(window.angular,window.console),function(e,n){"use strict";n.log("Loading controllers...Done.");var t=e.module("Station");t.controller("MapCtrl",["$scope","regionService",function(e,n){n.findAll().then(function(n){e.regions=n}),e.preview=function(n){e.showcase=n}}]),t.controller("RegionCtrl",["$scope","$routeParams","regionService",function(e,n,t){t.find(n.id).then(function(n){e.region=n})}]),t.controller("LocationCtrl",["$scope","$routeParams","locationService","playerService",function(e,t,r,o){e.showRoom=!0,e.showVessel=!1,e.showShop=!1,e.openVessel=function(t){n.log("Open vessel:",t),e.roomPlacementId=t,e.showRoom=!1,e.showVessel=!0},e.closeVessel=function(){e.showRoom=!0,e.showVessel=!1,e.roomPlacementId=null},e.openShop=function(n){e.roomPlacementId=n,e.showRoom=!1,e.showShop=!0},e.closeShop=function(){e.showRoom=!0,e.showShop=!1,e.roomPlacementId=null},e.openEnemy=function(e){n.log("Open enemy",e)},o.getPlayer().then(function(n){e.player=n}),r.find(t.id).then(function(n){e.location=n,e.room=n.rooms[0]})}]),t.controller("ShopCtrl",["$routeParams","playerService","npcService","inventoryService","$sce","$rootScope",function(t,r,o,a,i,c){function l(){h&&w&&(v(),m.isReady=!0)}function s(e,n){for(var t in n)if(n[t].itemId===e.itemId&&n[t].inCart===e.inCart){delete n[t];break}}function u(n,t,r){var o=e.copy(n);return 1===o.quantity?s(n,r.items):(n.quantity-=t,o.quantity=t,n.quantity<1&&s(n,r.items)),o}function p(e,n){var t=!1,r=n.items;"boolean"==typeof e.inCart?e.inCart=!e.inCart:e.inCart=!0;for(var o in r)if("undefined"==typeof r[o].inCart&&(r[o].inCart=!1),r[o].itemId===e.itemId&&r[o].inCart===e.inCart){r[o].quantity+=e.quantity,t=!0;break}t||(r.push(e),y(n)),f()}function f(){var e=0,n=0,t,r;r=m.trader.items;for(t in r)r[t].inCart===!0&&(e+=r[t].value*r[t].quantity);r=m.player.items;for(t in r)r[t].inCart===!0&&(n+=r[t].value*r[t].quantity);m.totals.difference=e-n,m.totals.display=d(m.totals.difference),m.isDisabled=m.totals.difference<0&&m.isOverage}function d(e){return 0===e?(m.isOverage=!1,m.totals.label="--","0"):0>e&&-1*m.player.money>e?(m.isOverage=!0,m.totals.label="Loss",e):m.trader.money<e?(m.isOverage=!0,e=m.trader.money,m.totals.label="Profit","+"+m.trader.money):(m.isOverage=!1,m.totals.label="Profit","+"+e)}function v(){var e=.5,n=.6,t;for(var r in m.player.items)t=m.player.items[r],t.value=Math.round(t.baseValue-t.baseValue*e);for(var o in m.trader.items)t=m.trader.items[o],t.value=Math.round(t.baseValue*(1+n))}function y(e){var n=[],t=[];for(var r in e.items)e.items[r].inCart===!0?n.push(e.items[r]):t.push(e.items[r]);n=a.sortAlpha(n),t=a.sortAlpha(t),e.items=n.concat(t)}var m=this,h=!1,w=!1,g={player:null,trader:null};m.player={},m.trader={},m.npcId=t.id,m.isReady=!1,m.totals={difference:0,display:"0",label:"--"},m.isDisabled=!0,r.getPlayer().then(function(t){n.log("playerService: ",t),g.player=e.copy(t.items),m.player=t,h=!0,l()}),o.find(m.roomPlacementId).then(function(t){n.log("npcService: ",t),g.trader=e.copy(t.items),m.trader=t,w=!0,l()}),m.buy={label:i.trustAsHtml("Take"),onPreview:function(e){this.label=e.inCart===!0?i.trustAsHtml('<span class="fa fa-arrow-up"></span>Take Back'):i.trustAsHtml('<span class="fa fa-arrow-up"></span>Take')},onAccept:function(e,n){var t=u(e,n,m.trader);p(t,m.player)},onCancel:function(){}},m.sell={label:i.trustAsHtml("Offer"),onPreview:function(e){this.label=e.inCart===!0?i.trustAsHtml('<span class="fa fa-arrow-down"></span>Give Back'):i.trustAsHtml('<span class="fa fa-arrow-down"></span>Offer')},onAccept:function(e,n){var t=u(e,n,m.player);p(t,m.trader)},onCancel:function(){}},m.back=function(){m.player.items=g.player,m.trader.items=g.trader,c.back()}}]),t.controller("InventoryCtrl",function(){function e(e){n.bundleValue=n.quantityRequested*e.value}var n=this;n.bundleValue=0,n.increaseQuantity=function(t){n.quantityRequested++,n.quantityRequested>t.quantity&&(n.quantityRequested=t.quantity),e(t)},n.decreaseQuantity=function(t){n.quantityRequested--,n.quantityRequested<1&&(n.quantityRequested=1),e(t)},n.preview=function(e){n.action&&n.action.onPreview&&n.action.onPreview.call(n.action,e),n.showcase=e},n.requestQuantity=function(t){1===t.quantity?(n.quantityRequested=1,n.accept(t)):(n.showQuantitySelect=!0,n.quantityRequested=t.quantity,e(t))},n.accept=function(e){n.action.onAccept(e,n.quantityRequested),n.cancel()},n.cancel=function(){delete n.quantityRequested,delete n.showcase,n.showQuantitySelect=!1}}),t.controller("VesselCtrl",["playerService","vesselService","$sce",function(e,t,r){var o=this;e.getPlayer().then(function(e){o.player=e}),t.find(o.roomPlacementId).then(function(e){n.log("Vessel: ",e),o.vessel=e}),o.take={label:r.trustAsHtml('<span class="fa fa-arrow-up"></span>Take'),onPreview:function(){},onAccept:function(){},onCancel:function(){}},o.store={label:r.trustAsHtml('<span class="fa fa-arrow-down"></span>Store'),onPreview:function(){},onAccept:function(){},onCancel:function(){}}}]),t.controller("PickpocketCtrl",["$scope","$routeParams","playerService","npcService","$sce","$rootScope",function(n,t,r,o,a,i){function c(){n.isReady=l&&s}var l=!1,s=!1,u={player:null,npc:null};n.npcId=t.id,n.isReady=!1,r.getPlayer().then(function(t){n.player=t,r.getInventory().then(function(t){u.player=e.copy(t.items),n.player.items=t.items,l=!0,c()})}),o.find(n.npcId).then(function(t){n.npc=t,o.getInventory(n.npcId).then(function(t){u.npc=e.copy(t.items),n.npc.items=t.items,s=!0,c()})}),n.back=function(){n.player.items=u.player,n.npc.items=u.npc,i.back()}}])}(window.angular,window.console);